<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Indonesian RAG Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h2>Chatbot RAG Bahasa Indonesia</h2>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" name="files" accept=".pdf" required multiple>
            <button type="submit">Unggah PDF</button>
        </form>
        <div id="upload-status"></div>
        <hr>
        <div id="chatbox"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Tulis atau ucapkan pertanyaan..." autocomplete="off">
            <button id="send-btn">Kirim</button>
            <button id="mic-btn">ðŸŽ¤</button>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');

        const addMessage = (sender, message, audioData = null) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';

            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const messageContent = document.createElement('span');
            messageContent.className = 'message-content';
            messageContent.innerHTML = `<b>${sender}:</b> ${sanitizedMessage}`;
            messageDiv.appendChild(messageContent);

            if (sender === 'Bot' && audioData) {
                const replayBtn = document.createElement('button');
                replayBtn.className = 'replay-btn';
                replayBtn.innerHTML = 'â–¶ï¸'; 
                replayBtn.dataset.audio = audioData;
                messageDiv.appendChild(replayBtn);
            }

            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        };
        
        const playAudio = (base64Audio) => {
            const audio = new Audio(`data:audio/mp3;base64,${base64Audio}`);
            audio.play().catch(e => {
                console.error("Audio playback failed:", e);
                addMessage('System', 'Gagal memutar audio balasan.');
            });
        };

        uploadForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(uploadForm);
            uploadStatus.textContent = "Mengunggah dan memproses PDF...";
            uploadStatus.style.color = '#7f8c8d';

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (res.ok) {
                    uploadStatus.textContent = data.message;
                    uploadStatus.style.color = '#27ae60';
                } else {
                    uploadStatus.textContent = `Error: ${data.error}`;
                    uploadStatus.style.color = '#e74c3c';
                }
            } catch (error) {
                uploadStatus.textContent = 'Network error during upload.';
                uploadStatus.style.color = '#e74c3c';
            }
        };

        const sendMessage = async () => {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('Anda', message);
            userInput.value = '';

            try {
                addMessage('Bot', '...'); 
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message})
                });
                
                chatbox.removeChild(chatbox.lastChild);
                const data = await res.json();
                
                if (data.error) {
                    addMessage('Bot', `Error: ${data.error}`);
                    return;
                }

                const botResponse = data.response;
                addMessage('Bot', botResponse, data.audio);

                if (data.audio) {
                    playAudio(data.audio);
                }

            } catch (error) {
                if (chatbox.lastChild && chatbox.lastChild.textContent.includes('...')) {
                    chatbox.removeChild(chatbox.lastChild);
                }
                addMessage('Bot', 'Network error during chat.');
            }
        };

        sendBtn.onclick = sendMessage;
        userInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        chatbox.addEventListener('click', (event) => {
            if (event.target && event.target.classList.contains('replay-btn')) {
                const audioData = event.target.dataset.audio;
                if (audioData) {
                    playAudio(audioData);
                }
            }
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            micBtn.onclick = () => {
                if (micBtn.classList.contains('recording')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            };

            recognition.onstart = () => {
                micBtn.classList.add('recording');
                micBtn.textContent = 'ðŸ”´';
                userInput.placeholder = "Mendengarkan...";
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording');
                micBtn.textContent = 'ðŸŽ¤';
                userInput.placeholder = "Tulis atau ucapkan pertanyaan...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                setTimeout(sendMessage, 100); 
            };
            
            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                addMessage('System', `Error pengenalan suara: ${event.error}`);
            };

        } else {
            micBtn.style.display = 'none';
            console.log("Speech Recognition not supported in this browser.");
        }
    </script>
</body>
</html>